{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags %}

{% block content %}
{# --- Page Header --- #}
<section class="bg-brand-50 py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center" data-aos="fade-up">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
            {{ page.headline }}
        </h1>
        {% if page.instructions %}
        <div class="prose prose-lg prose-teal max-w-2xl mx-auto">
            {{ page.instructions|richtext }}
        </div>
        {% endif %}
    </div>
</section>

{# ========== TWO-STEP BOOKING FLOW ========== #}
{% if services %}
<section class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-16" id="booking-flow">

    {# --- Step 1: Choose a Service --- #}
    <div id="step-select">
        <div class="flex items-center gap-3 mb-2" data-aos="fade-up">
            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-600 text-white font-bold text-sm">1</span>
            <h2 class="text-2xl font-bold text-gray-900">Choose a Service</h2>
        </div>
        <p class="text-gray-600 mb-8 ml-11" data-aos="fade-up">
            Select the service you'd like to book to see available times.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for service in services %}
            <div role="button"
                    tabindex="0"
                    aria-label="Select {{ service.title }}"
                    class="service-card bg-white border-2 border-gray-200 rounded-xl shadow-sm hover:shadow-lg
                           hover:border-brand-400 transition-all duration-300 p-6 flex flex-col text-left
                           focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 cursor-pointer"
                    data-slug="{{ service.slug }}"
                    data-title="{{ service.title }}"
                    data-cal-url="{{ service.cal_booking_url }}"
                    data-aos="fade-up">

                <div class="flex items-start justify-between mb-3">
                    <h3 class="text-xl font-bold text-gray-900">
                        {{ service.title }}
                    </h3>
                    <span class="text-xl font-bold text-brand-700 flex-shrink-0 ml-4">
                        {{ service.price_label }}
                    </span>
                </div>

                <p class="text-gray-600 text-sm leading-relaxed mb-4 flex-grow">
                    {{ service.short_summary }}
                </p>

                <div class="flex items-center justify-between">
                    {% if service.duration_label %}
                    <span class="text-sm text-gray-500">
                        ⏱ {{ service.duration_label }}
                    </span>
                    {% else %}
                    <span></span>
                    {% endif %}

                    <a href="{% pageurl service %}"
                       onclick="event.stopPropagation();"
                       class="text-brand-600 hover:text-brand-700 text-sm font-medium transition">
                        View details →
                    </a>
                </div>

                {# Selected indicator (hidden by default) #}
                <div class="selected-badge hidden mt-4 pt-3 border-t border-brand-200">
                    <span class="inline-flex items-center gap-1 text-brand-700 text-sm font-semibold">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                        </svg>
                        Selected
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    {# --- Step 2: Calendar & Availability (hidden until a service is selected) --- #}
    <div id="step-calendar" class="hidden mt-16">
        <div class="flex items-center gap-3 mb-2" data-aos="fade-up">
            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-600 text-white font-bold text-sm">2</span>
            <h2 class="text-2xl font-bold text-gray-900">Pick a Date & Time</h2>
        </div>
        <div class="flex items-center justify-between mb-8 ml-11">
            <p class="text-gray-600">
                Showing availability for: <strong id="selected-service-name" class="text-brand-700"></strong>
            </p>
            <button type="button" id="change-service-btn"
                    class="text-brand-600 hover:text-brand-700 text-sm font-medium transition underline">
                ← Change service
            </button>
        </div>

        {# --- Cal.com Embed --- #}
        <div id="cal-embed-container"
             class="rounded-xl overflow-hidden shadow-lg border border-gray-200 bg-white min-h-[600px] flex items-center justify-center">
            {# Loading spinner, replaced by iframe via JS #}
            <div id="cal-loading" class="text-center py-16">
                <svg class="animate-spin h-10 w-10 text-brand-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-gray-500">Loading calendar…</p>
            </div>
        </div>

        {# --- No Cal URL fallback --- #}
        <div id="no-cal-fallback" class="hidden text-center py-12">
            <div class="bg-brand-50 rounded-xl p-10 max-w-lg mx-auto">
                <svg class="w-14 h-14 text-brand-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                <p class="text-gray-600 text-lg mb-6">
                    Online booking for this service isn't available yet. Please contact us to schedule.
                </p>
                <a href="/contact/"
                   class="inline-block bg-brand-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-brand-700 transition">
                    Contact Us
                </a>
            </div>
        </div>
    </div>
</section>
{% endif %}

{# --- Cancellation Policy --- #}
{% if settings.home.SiteSettings.cancellation_policy %}
<section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-gray-50 border border-gray-200 rounded-xl p-8" data-aos="fade-up">
        <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5 text-brand-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M11.25 11.25l.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
            </svg>
            Cancellation Policy
        </h3>
        <div class="prose prose-sm prose-teal max-w-none text-gray-600">
            {{ settings.home.SiteSettings.cancellation_policy|richtext }}
        </div>
    </div>
</section>
{% endif %}

{# --- Fallback: no services configured at all --- #}
{% if not services %}
<section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    {% if page.booking_embed_url %}
    <div class="rounded-xl overflow-hidden shadow-lg border border-gray-200" data-aos="fade-up">
        <iframe src="{{ page.booking_embed_url }}"
                width="100%"
                height="700"
                frameborder="0"
                loading="lazy"
                title="Book an appointment">
        </iframe>
    </div>
    {% elif page.booking_link_url %}
    <div class="text-center py-12" data-aos="fade-up">
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-12 max-w-lg mx-auto">
            <svg class="w-16 h-16 text-brand-500 mx-auto mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
            </svg>
            <p class="text-gray-600 text-lg mb-8">
                Click below to choose a date and time that works for you.
            </p>
            <a href="{{ page.booking_link_url }}"
               target="_blank"
               rel="noopener noreferrer"
               class="inline-block bg-brand-600 text-white font-semibold px-10 py-4 rounded-lg text-lg hover:bg-brand-700 transition shadow-lg hover:shadow-xl">
                {{ page.booking_link_text }}
            </a>
        </div>
    </div>
    {% else %}
    <div class="text-center py-12" data-aos="fade-up">
        <div class="bg-brand-50 rounded-xl p-12 max-w-lg mx-auto">
            <svg class="w-16 h-16 text-brand-400 mx-auto mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            <h2 class="text-2xl font-bold text-gray-900 mb-3">Coming Soon</h2>
            <p class="text-gray-600 text-lg mb-6">
                Online booking will be available shortly. In the meantime, please contact us directly.
            </p>
            <a href="/contact/"
               class="inline-block bg-brand-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-brand-700 transition">
                Contact Us
            </a>
        </div>
    </div>
    {% endif %}
</section>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const cards = document.querySelectorAll('.service-card');
    const stepSelect = document.getElementById('step-select');
    const stepCalendar = document.getElementById('step-calendar');
    const embedContainer = document.getElementById('cal-embed-container');
    const calLoading = document.getElementById('cal-loading');
    const nocalFallback = document.getElementById('no-cal-fallback');
    const selectedName = document.getElementById('selected-service-name');
    const changeBtn = document.getElementById('change-service-btn');

    if (!cards.length) return;

    function selectService(slug) {
        const card = document.querySelector(`.service-card[data-slug="${slug}"]`);
        if (!card) return;

        const calUrl = card.dataset.calUrl;
        const title = card.dataset.title;

        // Highlight selected card
        cards.forEach(c => {
            c.classList.remove('border-brand-500', 'bg-brand-50', 'ring-2', 'ring-brand-200');
            c.classList.add('border-gray-200');
            c.querySelector('.selected-badge').classList.add('hidden');
        });
        card.classList.remove('border-gray-200');
        card.classList.add('border-brand-500', 'bg-brand-50', 'ring-2', 'ring-brand-200');
        card.querySelector('.selected-badge').classList.remove('hidden');

        // Show calendar step
        selectedName.textContent = title;
        stepCalendar.classList.remove('hidden');

        // Scroll to calendar
        stepCalendar.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Load Cal.com embed or show fallback
        if (calUrl) {
            nocalFallback.classList.add('hidden');
            embedContainer.classList.remove('hidden');
            calLoading.classList.remove('hidden');

            // Remove existing iframe if any
            const oldIframe = embedContainer.querySelector('iframe');
            if (oldIframe) oldIframe.remove();

            const iframe = document.createElement('iframe');
            iframe.src = calUrl;
            iframe.width = '100%';
            iframe.height = '700';
            iframe.frameBorder = '0';
            iframe.loading = 'lazy';
            iframe.title = 'Book ' + title;
            iframe.style.minHeight = '600px';

            iframe.addEventListener('load', function () {
                calLoading.classList.add('hidden');
            });

            embedContainer.appendChild(iframe);

            // Update URL without reloading
            const url = new URL(window.location);
            url.searchParams.set('service', slug);
            window.history.replaceState({}, '', url);
        } else {
            embedContainer.classList.add('hidden');
            nocalFallback.classList.remove('hidden');
        }
    }

    // Card click handlers
    cards.forEach(card => {
        card.addEventListener('click', function () {
            selectService(this.dataset.slug);
        });
        card.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                selectService(this.dataset.slug);
            }
        });
    });

    // Change service button
    if (changeBtn) {
        changeBtn.addEventListener('click', function () {
            stepCalendar.classList.add('hidden');
            cards.forEach(c => {
                c.classList.remove('border-brand-500', 'bg-brand-50', 'ring-2', 'ring-brand-200');
                c.classList.add('border-gray-200');
                c.querySelector('.selected-badge').classList.add('hidden');
            });
            // Remove iframe to stop loading
            const oldIframe = embedContainer.querySelector('iframe');
            if (oldIframe) oldIframe.remove();
            calLoading.classList.remove('hidden');

            stepSelect.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Clear URL param
            const url = new URL(window.location);
            url.searchParams.delete('service');
            window.history.replaceState({}, '', url);
        });
    }

    // Pre-select from query param (?service=slug)
    const preselected = '{{ preselected_slug|escapejs }}';
    if (preselected) {
        selectService(preselected);
    }
});
</script>
{% endblock %}
